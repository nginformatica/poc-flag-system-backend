
<h1 align="center">
  Flag System
</h1>

<h4 align="center">A TypeScript library for managing feature flags.</h4>

<p align="center">
  <a href="https://dev.azure.com/nginformatica/Pesquisa%20e%20Desenvolvimento/_apis/build/status/Flag%20System">
    <img src="https://dev.azure.com/nginformatica/Pesquisa%20e%20Desenvolvimento/_apis/build/status/Flag%20System%20-%20Documentation%20Deploy?branchName=main"
         alt="Pipeline">
  </a>
   <a href="https://dev.azure.com/nginformatica/Pesquisa%20e%20Desenvolvimento/_apis/build/status/Flag%20System">
    <img src="https://dev.azure.com/nginformatica/Pesquisa%20e%20Desenvolvimento/_apis/build/status/Flag%20System%20-%20Deploy?branchName=main"
         alt="Pipeline">
  </a>
  <a href="https://dev.azure.com/nginformatica/Pesquisa%20e%20Desenvolvimento/_apis/build/status/Flag%20System">
    <img src="https://dev.azure.com/nginformatica/Pesquisa%20e%20Desenvolvimento/_apis/build/status/Flag%20System%20PR%20Check?branchName=main&jobName=Job"
         alt="Pipeline">
  </a>
</p>

## About The Project

Flag System is a TypeScript library for managing feature flags in a project. It allows you to register flags and features, and control user access to these features based on their permissions.

## How To Use

First install the Flag System library in your project, you can use yarn:

```sh
yarn add git+ssh://git@ssh.dev.azure.com:v3/nginformatica/Pesquisa%20e%20Desenvolvimento/flag-system
```

Then you can use Flag System in your TypeScript project, you can import it like this:

```ts
import { FlagSystem, IFlags, IFlagSystem, FlagSysCallbacks } from 'flag-system'
```

### FlagSystem class

#### Constructor

The FlagSystem class has a constructor that accepts an object with the following properties:

**`userFlags`** (optional): An object that represents the flags and settings for the current user. This object should implement the IFlags interface.

**`organizationFlags`** (optional): An object that represents the flags and settings for the current organization. This object should also implement the IFlags interface.

**`cb`** (required\*): An object that implements the FlagSysCallbacks interface. This object provides callbacks that the Flag System uses to interact with the underlying system that manages flags and features. _While cb is a required param, except from getFlags, others callbacks are optional._

**`systemFlags`** (optional): An array of system flags.
Example usage:

```ts
const flagSystem = new FlagSystem({
    userFlags: {
        flags: ['user-flag-1', 'user-flag-2'],
        settings: {
            permissive: true
        }
    },
    organizationFlags: {
        flags: ['org-flag-1', 'org-flag-2'],
        settings: {
            permissive: true,
            asc: false
        }
    },
    cb: {
        async createFlag(flag: string, features: string[]): Promise<void> {
            // Implementation to create flag in your system
        },
        async updateFlag(flag: string, features: string[]): Promise<void> {
            // Implementation to create flag in your system
        },
        async getFlags(): Promise<Array<FlagReturn<string, string>>> {
            // Implementation to get all feature flags
        }
    },
    systemFlags: ['system-flag-1', 'system-flag-2']
})
```

#### Methods

The FlagSystem class has the following methods:

`canUserAccessFeature(feature: Feature): Promise<boolean>`: This method checks if the current user has access to a feature.

Example usage:

```ts
const canAccess = await flagSystem.canUserAccessFeature('feature-1')
```

`registerFlag(flag: Flag, features: Feature[]): Promise<Flag>`: This method registers a flag and its associated features in the underlying system that manages flags and features.

Example usage:

```ts
await flagSystem.registerFlag('new-flag', ['new-feature-1', 'new-feature-2'])
```

`findFlagsRelatedToFeature(feature: Feature): Promise<Flag[]>`: This method finds all flags that are related to a specific feature.

Example usage:

```ts
const flags = await flagSystem.findFlagsRelatedToFeature('feature-1')
```

#### Interfaces

The Flag System library comes with the following interfaces that you can use to define your objects:

**`FlagSysCallbacks<Flag, Feature>`**: This interface defines the callbacks that the Flag System uses to interact with the underlying system that manages flags and features.

**`createFlag(flag: Flag, features: Feature[]) => Promise<Flag>`**: A callback that creates a flag and its associated features in the underlying system.

**`updateFlag(flag: Flag, features: Feature[]) => Promise<Flag>`**: A callback that updates a flag and its associated features in the underlying system.

**`getFlags(): Promise<Array<FlagReturn<Flag, Feature>>>`**: A callback that gets the features associated with a flag from the underlying system.

Example implementation:

```ts
const cb: FlagSysCallbacks<string, string> = {
    async createFlag(flag: string, features: string[]): Promise<void> {
        // Implementation to create flag in your system
    },
    async updateFlag(flag: string, features: string[]): Promise<void> {
        // Implementation to create flag in your system
    },
    async getFlags(): Promise<Array<FlagReturn<string, string>>> {
        // Implementation to get all feature flags
    }
}
```

#### Exceptions

Since some parameters are not enforced, exceptions can be thrown depending on the implementation and the use of the library.
Flag System library comes with following exceptions you can use to handle errors:

**`NoFlagError`**: This exception is thrown when a flag is not defined.

Example:

```ts
// This will throw a NoFlagError exception since systemFlags is not defined
const flagSystem = new FlagSystem({
    cb: {
        //...
    }
})
await flagSystem.registerFlag('system-flag-1', [
    'new-feature-1',
    'new-feature-2'
])

// Correct implementation
const flagSystem = new FlagSystem({
    cb: {
        //...
    },
    systemFlags: ['system-flag-1', 'system-flag-2']
})
await flagSystem.registerFlag('system-flag-1', [
    'new-feature-1',
    'new-feature-2'
])
```

**`CallbacksNotDefinedError`**: This exception is thrown when a callback is not defined.

Example:

```ts
// This will throw a CallbacksNotDefinedError exception if the createFlag callback is not defined
const flagSystem = new FlagSystem({
    cb: {
        async getFlags(): Promise<Array<FlagReturn<Flag, Feature>>> {
            // Implementation to get all feature flags
        }
    },
    systemFlags: ['system-flag-1', 'system-flag-2']
})
await flagSystem.registerFlag('system-flag-1', [
    'new-feature-1',
    'new-feature-2'
])

// Correct implementation
const flagSystem = new FlagSystem({
    cb: {
        async createFlag(flag: string, features: string[]): Promise<void> {
            // Implementation to create flag in your system
        },
        async getFlags(): Promise<Array<FlagReturn<Flag, Feature>>> {
            // Implementation to get all feature flags
        }
    },
    systemFlags: ['system-flag-1', 'system-flag-2']
})
await flagSystem.registerFlag('system-flag-1', [
    'new-feature-1',
    'new-feature-2'
])
```

**`EntityNotDefinedError`**: This exception is thrown when an entity is not defined.

Example:

```ts
// This will throw a EntityNotDefinedError exception since organizationFlags is not defined
const flagSystem = new FlagSystem({
    userFlags: {
        //...
    },
    cb: {
        //...
    }
})
await flagSystem.canUserAccessFeature('new-feature-1')

// Correct implementation
const flagSystem = new FlagSystem({
    userFlags: {
        //...
    },
    organizationFlags: {
        //...
    },
    cb: {
        //...
    }
})
await flagSystem.canUserAccessFeature('new-feature-1')
```
