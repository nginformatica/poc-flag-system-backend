!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["flag-system"]=t():e["flag-system"]=t()}(this,(()=>(()=>{"use strict";var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};function r(e){return null!=e&&"object"==typeof e&&!0===e["@@functional/placeholder"]}function n(e){return function t(n){return 0===arguments.length||r(n)?t:e.apply(this,arguments)}}function a(e){return function t(a,s){switch(arguments.length){case 0:return t;case 1:return r(a)?t:n((function(t){return e(a,t)}));default:return r(a)&&r(s)?t:r(a)?n((function(t){return e(t,s)})):r(s)?n((function(t){return e(a,t)})):e(a,s)}}}e.r(t),e.d(t,{CallbacksNotDefinedError:()=>Y,FeatureNotFoundError:()=>Z,FeatureVersion:()=>re,FlagInUseError:()=>te,FlagNotFoundError:()=>ee,FlagSystem:()=>ae});const s=Array.isArray||function(e){return null!=e&&e.length>=0&&"[object Array]"===Object.prototype.toString.call(e)};function i(e,t,r){return function(){if(0===arguments.length)return r();var n=arguments[arguments.length-1];if(!s(n)){for(var a=0;a<e.length;){if("function"==typeof n[e[a]])return n[e[a]].apply(n,Array.prototype.slice.call(arguments,0,-1));a+=1}if(function(e){return null!=e&&"function"==typeof e["@@transducer/step"]}(n))return t.apply(null,Array.prototype.slice.call(arguments,0,-1))(n)}return r.apply(this,arguments)}}const o=function(){return this.xf["@@transducer/init"]()},u=function(e){return this.xf["@@transducer/result"](e)};function c(e){return"[object String]"===Object.prototype.toString.call(e)}const l=n((function(e){return!!s(e)||!!e&&"object"==typeof e&&!c(e)&&(0===e.length||e.length>0&&e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1))}));var f=function(){function e(e){this.f=e}return e.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},e.prototype["@@transducer/result"]=function(e){return e},e.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},e}();function g(e,t){switch(e){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,r){return t.apply(this,arguments)};case 3:return function(e,r,n){return t.apply(this,arguments)};case 4:return function(e,r,n,a){return t.apply(this,arguments)};case 5:return function(e,r,n,a,s){return t.apply(this,arguments)};case 6:return function(e,r,n,a,s,i){return t.apply(this,arguments)};case 7:return function(e,r,n,a,s,i,o){return t.apply(this,arguments)};case 8:return function(e,r,n,a,s,i,o,u){return t.apply(this,arguments)};case 9:return function(e,r,n,a,s,i,o,u,c){return t.apply(this,arguments)};case 10:return function(e,r,n,a,s,i,o,u,c,l){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}}const h=a((function(e,t){return g(e.length,(function(){return e.apply(t,arguments)}))}));function p(e,t,r){for(var n=r.next();!n.done;){if((t=e["@@transducer/step"](t,n.value))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}n=r.next()}return e["@@transducer/result"](t)}function y(e,t,r,n){return e["@@transducer/result"](r[n](h(e["@@transducer/step"],e),t))}var d="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";function b(e,t,r){if("function"==typeof e&&(e=function(e){return new f(e)}(e)),l(r))return function(e,t,r){for(var n=0,a=r.length;n<a;){if((t=e["@@transducer/step"](t,r[n]))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}n+=1}return e["@@transducer/result"](t)}(e,t,r);if("function"==typeof r["fantasy-land/reduce"])return y(e,t,r,"fantasy-land/reduce");if(null!=r[d])return p(e,t,r[d]());if("function"==typeof r.next)return p(e,t,r);if("function"==typeof r.reduce)return y(e,t,r,"reduce");throw new TypeError("reduce: list must be array or iterable")}var F=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=o,e.prototype["@@transducer/result"]=u,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},e}();const v=a((function(e,t){return new F(e,t)}));function m(e,t,n){return function(){for(var a=[],s=0,i=e,o=0;o<t.length||s<arguments.length;){var u;o<t.length&&(!r(t[o])||s>=arguments.length)?u=t[o]:(u=arguments[s],s+=1),a[o]=u,r(u)||(i-=1),o+=1}return i<=0?n.apply(this,a):g(i,m(e,a,n))}}const w=a((function(e,t){return 1===e?n(t):g(e,m(e,[],t))}));function A(e,t){return Object.prototype.hasOwnProperty.call(t,e)}var O=Object.prototype.toString;const E=function(){return"[object Arguments]"===O.call(arguments)?function(e){return"[object Arguments]"===O.call(e)}:function(e){return A("callee",e)}}();var S=!{toString:null}.propertyIsEnumerable("toString"),j=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],U=function(){return arguments.propertyIsEnumerable("length")}(),I=function(e,t){for(var r=0;r<e.length;){if(e[r]===t)return!0;r+=1}return!1};const D="function"!=typeof Object.keys||U?n((function(e){if(Object(e)!==e)return[];var t,r,n=[],a=U&&E(e);for(t in e)!A(t,e)||a&&"length"===t||(n[n.length]=t);if(S)for(r=j.length-1;r>=0;)A(t=j[r],e)&&!I(n,t)&&(n[n.length]=t),r-=1;return n})):n((function(e){return Object(e)!==e?[]:Object.keys(e)})),N=a(i(["fantasy-land/map","map"],v,(function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return w(t.length,(function(){return e.call(this,t.apply(this,arguments))}));case"[object Object]":return b((function(r,n){return r[n]=e(t[n]),r}),{},D(t));default:return function(e,t){for(var r=0,n=t.length,a=Array(n);r<n;)a[r]=e(t[r]),r+=1;return a}(e,t)}}))),x=Number.isInteger||function(e){return e<<0===e},P=a((function(e,t){var r=e<0?t.length+e:e;return c(t)?t.charAt(r):t[r]})),z=a((function(e,t){if(null!=t)return x(e)?P(e,t):t[e]}));function k(e){return function t(s,i,o){switch(arguments.length){case 0:return t;case 1:return r(s)?t:a((function(t,r){return e(s,t,r)}));case 2:return r(s)&&r(i)?t:r(s)?a((function(t,r){return e(t,i,r)})):r(i)?a((function(t,r){return e(s,t,r)})):n((function(t){return e(s,i,t)}));default:return r(s)&&r(i)&&r(o)?t:r(s)&&r(i)?a((function(t,r){return e(t,r,o)})):r(s)&&r(o)?a((function(t,r){return e(t,i,r)})):r(i)&&r(o)?a((function(t,r){return e(s,t,r)})):r(s)?n((function(t){return e(t,i,o)})):r(i)?n((function(t){return e(s,t,o)})):r(o)?n((function(t){return e(s,i,t)})):e(s,i,o)}}}const q=k(b);function C(e){for(var t,r=[];!(t=e.next()).done;)r.push(t.value);return r}function M(e,t,r){for(var n=0,a=r.length;n<a;){if(e(t,r[n]))return!0;n+=1}return!1}const T="function"==typeof Object.is?Object.is:function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t},V=n((function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)}));function R(e,t,r,n){var a=C(e);function s(e,t){return L(e,t,r.slice(),n.slice())}return!M((function(e,t){return!M(s,t,e)}),C(t),a)}function L(e,t,r,n){if(T(e,t))return!0;var a,s,i=V(e);if(i!==V(t))return!1;if("function"==typeof e["fantasy-land/equals"]||"function"==typeof t["fantasy-land/equals"])return"function"==typeof e["fantasy-land/equals"]&&e["fantasy-land/equals"](t)&&"function"==typeof t["fantasy-land/equals"]&&t["fantasy-land/equals"](e);if("function"==typeof e.equals||"function"==typeof t.equals)return"function"==typeof e.equals&&e.equals(t)&&"function"==typeof t.equals&&t.equals(e);switch(i){case"Arguments":case"Array":case"Object":if("function"==typeof e.constructor&&"Promise"===(a=e.constructor,null==(s=String(a).match(/^function (\w*)/))?"":s[1]))return e===t;break;case"Boolean":case"Number":case"String":if(typeof e!=typeof t||!T(e.valueOf(),t.valueOf()))return!1;break;case"Date":if(!T(e.valueOf(),t.valueOf()))return!1;break;case"Error":return e.name===t.name&&e.message===t.message;case"RegExp":if(e.source!==t.source||e.global!==t.global||e.ignoreCase!==t.ignoreCase||e.multiline!==t.multiline||e.sticky!==t.sticky||e.unicode!==t.unicode)return!1}for(var o=r.length-1;o>=0;){if(r[o]===e)return n[o]===t;o-=1}switch(i){case"Map":return e.size===t.size&&R(e.entries(),t.entries(),r.concat([e]),n.concat([t]));case"Set":return e.size===t.size&&R(e.values(),t.values(),r.concat([e]),n.concat([t]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var u=D(e);if(u.length!==D(t).length)return!1;var c=r.concat([e]),l=n.concat([t]);for(o=u.length-1;o>=0;){var f=u[o];if(!A(f,t)||!L(t[f],e[f],c,l))return!1;o-=1}return!0}const B=a((function(e,t){return L(e,t,[],[])}));Date.prototype.toISOString;const _=a((function(e,t){return t>e?t:e})),$=n((function(e){return g(q(_,0,N((function(e){return e[0].length}),e)),(function(){for(var t=0;t<e.length;){if(e[t][0].apply(this,arguments))return e[t][1].apply(this,arguments);t+=1}}))})),G=k((function(e,t,r){for(var n=[],a=0,s=t.length;a<s;)M(e,t[a],r)||M(e,t[a],n)||n.push(t[a]),a+=1;return n})),K=k((function(e,t,r){return B(e(t),e(r))}));"function"==typeof Object.assign&&Object.assign;const W=a((function(e,t){return null==t||t!=t?e:t})),X=k((function(e,t,r){return W(e,z(t,r))}));String.prototype.trim;var H=function(){function e(e,t){this.xf=t,this.pred=e,this.items=[]}return e.prototype["@@transducer/init"]=o,e.prototype["@@transducer/result"]=u,e.prototype["@@transducer/step"]=function(e,t){return M(this.pred,t,this.items)?e:(this.items.push(t),this.xf["@@transducer/step"](e,t))},e}();const J=a(i([],a((function(e,t){return new H(e,t)})),(function(e,t){for(var r,n=0,a=t.length,s=[];n<a;)M(e,r=t[n],s)||(s[s.length]=r),n+=1;return s}))),Q=k((function(e,t,r){return J(e,function(e,t){var r;t=t||[];var n=(e=e||[]).length,a=t.length,s=[];for(r=0;r<n;)s[s.length]=e[r],r+=1;for(r=0;r<a;)s[s.length]=t[r],r+=1;return s}(t,r))}));class Y extends Error{constructor(e){super(`Callback ${e} is not defined`),this.name="CallbacksNotDefinedError"}}class Z extends Error{constructor(){super("Feature not found"),this.name="FeatureNotFoundError"}}class ee extends Error{constructor(){super("Flag not found"),this.name="FlagNotFoundError"}}class te extends Error{constructor(e,t){super(`Flag from ${t.join(" and ")} is in use by ${e.join(", ")}`),this.name="FlagInUseError"}}let re;!function(e){e.Stable="STABLE",e.Development="DEVELOPMENT",e.NotAvailable="NOT_AVAILABLE",e.FallBack="FALL_BACK"}(re||(re={}));class ne{defaultVersion=re.Stable;constructor(e,t="true"===process.env.FLAG_DEV,r=!1){this.cb=e,this.isDev=t,this.isDebugMode=r}async isAllowed(e,t){const r=await this.cb.getFlags(),n=t.flags,a=new Map;for(const e of r)if(n.includes(e.flag))for(const t of e.features){const r=a.get(t.feature);(!r||r.priority<e.priority)&&a.set(t.feature,{version:t.version,priority:e.priority})}const s=a.get(e);return s?{available:!0,version:s.version}:{available:!1,version:re.NotAvailable}}getFeatureVersion(e,t,r){return e===re.NotAvailable&&t===re.NotAvailable?re.NotAvailable:t===re.NotAvailable?r?e:re.NotAvailable:e===re.NotAvailable?r?t:re.NotAvailable:t===re.Development?t:e===re.Development?e:re.Stable}removeDuplicated(e){return[...new Set(e)]}async debug(){const e=[],t=[],r=[],n=await this.cb.getFlags(),a=this.cb.getAllUsersInterfaces?await this.cb.getAllUsersInterfaces():void 0,s=this.cb.getAllOrganizationsInterfaces?await this.cb.getAllOrganizationsInterfaces():void 0;for(let e=0;e<n.length;e++){const r=n[e].flag,a=n[e].features;for(let e=0;e<a.length;e++){const n=a[e].feature,s=a[e].version;t.push({flag:r,feature:n,version:s})}}if(a)for(let t=0;t<a.length;t++){const r=a[t].name,n=a[t].interface.flags;e.push({"User Name":r,flags:n})}if(s)for(let e=0;e<s.length;e++){const t=s[e].name,n=s[e].interface.flags;r.push({"Organization Name":t,flags:n})}return[t,e,r]}async getAllInterfaces(){const{getAllUsersInterfaces:e,getAllOrganizationsInterfaces:t}=this.cb;if(!e)throw new Y("getAllUsersInterfaces");if(!t)throw new Y("getAllOrganizationsInterfaces");return(await Promise.all([e(),t()])).flat()}async getUserOrganization(e){const{getOrganizationInterfaceFromUserId:t}=this.cb;if(!t)throw new Y("getOrganizationInterfaceFromUserId");return t(e)}async getUser(e){const{getUserInterface:t}=this.cb;if(!t)throw new Y("getUserInterface");return t(e)}async coreFlagEntity(e,t,r,n){const a="user"===r,s=a?this.cb.getUserInterface:this.cb.getOrganizationInterface,i=a?this.cb.flagUser:this.cb.flagOrganization;if(!s)throw new Y(a?"getUserInterface":"getOrganizationInterface");if(!i)throw new Y(a?"flagUser":"flagOrganization");const o=this.removeDuplicated(Array.isArray(t)?t:[t]),u=await s(e),c=this.removeDuplicated([...u.flags,...o]),l=B(u.flags,t),f=Object.assign({},u,"insert"===n?{flags:c}:{flags:o}),g=B(u.flags,f.flags);return l||g?u.flags:i(e,f)}async removeFlag(e){if(!this.cb.removeFlag)throw new Y("removeFlag");return await this.cb.removeFlag(e),e}async corePurgeFlag(e,t){const r=this.removeDuplicated(Array.isArray(e)?e:[e]),n=async()=>Promise.all(r.map((async e=>this.removeFlag(e))));return await $([[B("unsafe"),n],[B("force"),async()=>{const e=await this.getAllInterfaces();return(await Promise.all([e.map((async e=>{const t=e.interface.flags.filter((e=>!r.includes(e)));await this.coreFlagEntity(e.id,t,e.entity,"update")})),n()]))[1]}],[B("safe"),async()=>{const e=await this.getAllInterfaces(),t=new Set,n=new Set,a=e.filter((e=>e.interface.flags.some((e=>r.includes(e)))));if(a.length){for(const e of a)t.add(e.name),n.add(e.entity);throw new te(Array.from(t),Array.from(n))}return Promise.all(r.map((async e=>this.removeFlag(e))))}]])(t)}enableDebugMode=()=>{this.isDebugMode=!0};async coreCanUserAccessFeature(e,t){const r=await this.getUser(e),n=await this.getUserOrganization(e);if(this.isDev)return{available:!0,version:re.Development};const a=await this.isAllowed(t,r),s=await this.isAllowed(t,n),i=n.settings.permissive,o=this.getFeatureVersion(s.version,a.version,i);return i?{available:a.available||s.available,version:o}:{available:a.available&&s.available,version:o}}async coreRegisterFlag(e,t,r){if(!this.cb.createFlag)throw new Y("createFlag");const n=new Set(r),a=(e,t,r)=>r.filter((t=>t.feature===e.feature)).length>1;if(r.some(a)){const e=r.filter(a);e.forEach((e=>{n.delete(e)})),n.add({feature:e[0].feature,version:this.defaultVersion})}return this.cb.createFlag(e,t,Array.from(n))}async coreUpdateFlag(e,t,r,n){if(!this.cb.updateFlag)throw new Y("updateFlag");const a=(e,t,r)=>r.filter((t=>t.feature===e.feature)).length>1,s=r.some(a),i=new Set;if(s){const e=r.filter(a);e.forEach((e=>{i.delete(e)})),i.add({feature:e[0].feature,version:this.defaultVersion})}else r.forEach((e=>i.add(e)));if("insert"===n){const n=(await this.cb.getFlags()).find((t=>t.flag===e));if(n){const a=G(K(z("feature")),n.features,r),s=Q(K(z("feature")),a,Array.from(i));return this.cb.updateFlag(e,t,s)}}return this.cb.updateFlag(e,t,Array.from(i))}async coreFindFlagsRelatedToFeature(e){const t=await this.cb.getFlags(),r=[],n=(e,t)=>{const r=e.features.filter((e=>e.feature===t));if(r.length)return r[0].version};for(let a=0;a<t.length;a++){const s=n(t[a],e);s&&r.push({flag:t[a].flag,version:s})}return r}async coreUpdateFeatureVersion(e,t,r){const n=(await this.cb.getFlags()).find((e=>e.flag===r));if(!n)throw new ee;const a=n.features.find((t=>t.feature===e));if(!a)throw new Z;return a.version=t,{flag:await this.coreUpdateFlag(n.flag,n.priority,n.features,"update"),feature:e,version:t}}async coreFindFloatingFeatures(e){const t=this.removeDuplicated(e),r=(await this.cb.getFlags()).flatMap((e=>e.features.map((e=>e.feature))));return t.filter((e=>!new Set(r).has(e)))}async corePurgeFeature(e){const t=this.removeDuplicated(Array.isArray(e)?e:[e]),r=(await this.cb.getFlags()).filter((e=>e.features.some((e=>t.includes(e.feature))))),n=[],a=[];return await Promise.all(r.map((async e=>{const r=e.features.filter((e=>!t.includes(e.feature)));if(r.length){const t=await this.coreUpdateFlag(e.flag,e.priority,r,"update");a.push(t)}else{const t=await this.removeFlag(e.flag);n.push(t)}}))),{updatedFlags:a,removedFlags:n}}async coreFindFloatingFlags(e){const t=this.removeDuplicated(e),r=(await this.cb.getFlags()).map((e=>e.flag));return t.filter((e=>!new Set(r).has(e)))}async coreFindFeaturesRelatedToFlag(e){const t=(await this.cb.getFlags()).find((t=>t.flag===e));return X([],"features",t)}async coreFindAnyFeatureCollision(){const e=(await this.cb.getFlags()).flatMap((e=>({features:e.features.map((e=>e.feature)),priority:e.priority,flag:e.flag}))),t=new Map;e.forEach((e=>{e.features.forEach((r=>{const n=t.get(r);n?t.set(r,[...n,{flag:e.flag,priority:e.priority}]):t.set(r,[{flag:e.flag,priority:e.priority}])}))}));const r=[];return t.forEach(((e,t)=>{e.length>1&&r.push({feature:t,flags:e})})),r}async handler(e){const t=this.isDebugMode?await this.debug():void 0;try{return{res:await e(),debug:t}}catch(e){return{error:z("message",e),debug:t}}}}const ae=class extends ne{constructor(e){super(e.cb)}async canUserAccessFeature(e,t){return this.handler((async()=>this.coreCanUserAccessFeature(e,t)))}async registerFlag(e,t,r){return this.handler((async()=>this.coreRegisterFlag(e,t,r)))}async updateFlag(e,t,r,n){return this.handler((async()=>this.coreUpdateFlag(e,t,r,n)))}async findFlagsRelatedToFeature(e){return this.handler((async()=>this.coreFindFlagsRelatedToFeature(e)))}async findFeaturesRelatedToFlag(e){return this.handler((async()=>this.coreFindFeaturesRelatedToFlag(e)))}async updateFeatureVersion(e,t,r){return this.handler((async()=>this.coreUpdateFeatureVersion(e,t,r)))}async findFloatingFeatures(e){return this.handler((async()=>this.coreFindFloatingFeatures(e)))}async findFloatingFlags(e){return this.handler((async()=>this.coreFindFloatingFlags(e)))}async purgeFeature(e){return this.handler((async()=>this.corePurgeFeature(e)))}async purgeFlag(e,t){return this.handler((async()=>this.corePurgeFlag(e,t)))}async flagEntity(e,t,r,n){return this.handler((async()=>this.coreFlagEntity(e,t,r,n)))}async dump(){return this.debug()}async findAnyFeatureCollision(){return this.handler((async()=>this.coreFindAnyFeatureCollision()))}};return t})()));